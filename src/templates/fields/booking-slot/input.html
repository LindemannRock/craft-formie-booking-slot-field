{# Set default variables #}
{% set name = field.getHtmlName() %}
{% set value = value ?? field.defaultValue ?? null %}
{% set dateValue = value.date ?? null %}
{% set slotValue = value.slot ?? null %}

{# Get generated dates and slots #}
{% set availableDates = field.getAvailableDates() %}
{% set timeSlots = field.getTimeSlots() %}

<div class="fui-booking-slot-wrapper" data-fui-booking-slot>
    {# Date Selection #}
    {% set datePosition = field.dateSelectionLabelPosition is not empty ? field.dateSelectionLabelPosition : form.settings.defaultLabelPosition %}
    {% set showDateLabel = datePosition != 'verbb\\formie\\positions\\Hidden' %}
    {% set dateLabelAbove = not datePosition or datePosition == 'verbb\\formie\\positions\\AboveInput' %}
    {% set dateLabelBelow = datePosition == 'verbb\\formie\\positions\\BelowInput' %}
    {% set dateLabelLeft = datePosition == 'verbb\\formie\\positions\\LeftInput' %}
    {% set dateLabelRight = datePosition == 'verbb\\formie\\positions\\RightInput' %}

    <div class="fui-booking-dates {{ dateLabelLeft or dateLabelRight ? 'flex items-center gap-4' }} {{ dateLabelRight ? 'flex-row-reverse' }}" data-booking-dates>
        {% if showDateLabel and (dateLabelAbove or dateLabelLeft or dateLabelRight) %}
            <label class="fui-booking-label {{ dateLabelLeft or dateLabelRight ? 'flex-shrink-0 mb-0' }}">{{ field.dateSelectionLabel|t('formie') }}</label>
        {% endif %}

        <div class="{{ dateLabelLeft or dateLabelRight ? 'flex-1' }}">

        {% if field.dateDisplayType == 'select' %}
            {# Dropdown Select #}
            <select
                name="{{ name }}[date]"
                {% if field.required %}required{% endif %}
                data-date-input
                class="fui-select"
            >
                <option value="">{{ field.datePlaceholder|t('formie') }}</option>
                {% for dateConfig in availableDates %}
                    {% set dateVal = dateConfig.date ?? dateConfig %}
                    {% set dateLabel = dateConfig.label ?? dateVal %}
                    <option value="{{ dateVal }}" {% if dateValue == dateVal %}selected{% endif %}>
                        {{ dateLabel }}
                    </option>
                {% endfor %}
            </select>
        {% else %}
            {# Radio Buttons #}
            <div class="fui-date-options">
                {% for dateConfig in availableDates %}
                    {% set dateVal = dateConfig.date ?? dateConfig %}
                    {% set dateLabel = dateConfig.label ?? dateVal %}

                    <label class="fui-date-option {% if dateValue == dateVal %}is-selected{% endif %}">
                        <input
                            type="radio"
                            name="{{ name }}[date]"
                            value="{{ dateVal }}"
                            {% if dateValue == dateVal %}checked{% endif %}
                            {% if field.required %}required{% endif %}
                            data-date-input
                            class="fui-date-radio"
                        />
                        <span class="fui-date-label">{{ dateLabel }}</span>
                    </label>
                {% endfor %}
            </div>
        {% endif %}
        </div>

        {% if showDateLabel and dateLabelBelow %}
            <label class="fui-booking-label mt-2">{{ field.dateSelectionLabel|t('formie') }}</label>
        {% endif %}
    </div>

    {# Time Slot Selection #}
    {% set slotPosition = field.slotSelectionLabelPosition is not empty ? field.slotSelectionLabelPosition : form.settings.defaultLabelPosition %}
    {% set showSlotLabel = slotPosition != 'verbb\\formie\\positions\\Hidden' %}
    {% set slotLabelAbove = not slotPosition or slotPosition == 'verbb\\formie\\positions\\AboveInput' %}
    {% set slotLabelBelow = slotPosition == 'verbb\\formie\\positions\\BelowInput' %}
    {% set slotLabelLeft = slotPosition == 'verbb\\formie\\positions\\LeftInput' %}
    {% set slotLabelRight = slotPosition == 'verbb\\formie\\positions\\RightInput' %}

    <div class="fui-booking-slots {{ slotLabelLeft or slotLabelRight ? 'flex items-center gap-4' }} {{ slotLabelRight ? 'flex-row-reverse' }} {% if not dateValue %}is-disabled{% endif %}" data-booking-slots>
        {% if showSlotLabel and (slotLabelAbove or slotLabelLeft or slotLabelRight) %}
            <label class="fui-booking-label {{ slotLabelLeft or slotLabelRight ? 'flex-shrink-0 mb-0' }}">{{ field.slotSelectionLabel|t('formie') }}</label>
        {% endif %}

        <div class="{{ slotLabelLeft or slotLabelRight ? 'flex-1' }}">

        {% if field.slotDisplayType == 'select' %}
            {# Dropdown Select #}
            <select
                name="{{ name }}[slot]"
                {% if field.required %}required{% endif %}
                data-slot-input
                class="fui-select"
            >
                <option value="">{{ field.slotPlaceholder|t('formie') }}</option>
                {% for slotConfig in timeSlots %}
                    {% set slotKey = slotConfig.startTime ~ '-' ~ slotConfig.endTime %}
                    {% set slotLabel = slotConfig.label ?? slotKey %}
                    {% set remaining = dateValue ? field.getRemainingCapacity(dateValue, slotKey) : field.maxCapacityPerSlot %}
                    {% set isFull = remaining <= 0 %}

                    <option
                        value="{{ slotKey }}"
                        {% if slotValue == slotKey %}selected{% endif %}
                        {% if isFull %}disabled{% endif %}
                        data-slot-key="{{ slotKey }}"
                        data-remaining="{{ remaining }}"
                    >
                        {{ slotLabel }}
                        {% if field.showRemainingCapacity %}
                            - {% if isFull %}{{ field.fullyBookedText|t('formie') }}{% else %}{{ field.capacityTemplate|t('formie')|replace('{count}', remaining) }}{% endif %}
                        {% endif %}
                    </option>
                {% endfor %}
            </select>
        {% else %}
            {# Radio Buttons #}
            <div class="fui-slot-options">
                {% for slotConfig in timeSlots %}
                    {% set slotKey = slotConfig.startTime ~ '-' ~ slotConfig.endTime %}
                    {% set slotLabel = slotConfig.label ?? slotKey %}

                    {# Calculate remaining capacity #}
                    {% set remaining = dateValue ? field.getRemainingCapacity(dateValue, slotKey) : field.maxCapacityPerSlot %}
                    {% set isFull = remaining <= 0 %}

                    <label class="fui-slot-option {% if slotValue == slotKey %}is-selected{% endif %} {% if isFull %}is-full{% endif %}"
                           data-slot-key="{{ slotKey }}"
                           data-remaining="{{ remaining }}">
                        <input
                            type="radio"
                            name="{{ name }}[slot]"
                            value="{{ slotKey }}"
                            {% if slotValue == slotKey %}checked{% endif %}
                            {% if field.required %}required{% endif %}
                            {% if isFull %}disabled{% endif %}
                            data-slot-input
                            class="fui-slot-radio"
                        />
                        <span class="fui-slot-label">
                            <span class="fui-slot-time">{{ slotLabel }}</span>
                            {% if field.showRemainingCapacity %}
                                <span class="fui-slot-capacity {% if isFull %}is-full{% endif %}">
                                    {% if isFull %}
                                        {{ field.fullyBookedText|t('formie') }}
                                    {% else %}
                                        {{ field.capacityTemplate|t('formie')|replace('{count}', remaining) }}
                                    {% endif %}
                                </span>
                            {% endif %}
                        </span>
                    </label>
                {% endfor %}
            </div>
        {% endif %}
        </div>

        {% if showSlotLabel and slotLabelBelow %}
            <label class="fui-booking-label mt-2">{{ field.slotSelectionLabel|t('formie') }}</label>
        {% endif %}
    </div>
</div>
